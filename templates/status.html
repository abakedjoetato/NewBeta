{% extends 'base.html' %}

{% block title %}Bot Status - Tower of Temptation PvP Statistics Bot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Bot Status</h1>
    </div>
</div>

<!-- Current Status Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">Current Status</h5>
            </div>
            <div class="card-body">
                {% if bot_status %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3">
                                    {% if bot_status.is_online %}
                                        <span class="badge bg-success rounded-pill p-2">
                                            <i data-feather="check-circle"></i> Online
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger rounded-pill p-2">
                                            <i data-feather="x-circle"></i> Offline
                                        </span>
                                    {% endif %}
                                </div>
                                <h4 class="mb-0">Bot Status</h4>
                            </div>
                            <p>Last Updated: {{ bot_status.timestamp.strftime('%Y-%m-%d %H:%M:%S UTC') }}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">{{ bot_status.guild_count }}</h3>
                                            <p class="card-text text-muted">Servers</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">{{ "%d:%02d:%02d" | format(bot_status.uptime_seconds // 3600, (bot_status.uptime_seconds % 3600) // 60, bot_status.uptime_seconds % 60) }}</h3>
                                            <p class="card-text text-muted">Uptime</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>Version:</strong> {{ bot_status.version }}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i data-feather="alert-triangle"></i> No status information available.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Errors Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">Recent Errors</h5>
            </div>
            <div class="card-body">
                {% if recent_errors %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Level</th>
                                    <th>Source</th>
                                    <th>Message</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for error in recent_errors %}
                                    <tr>
                                        <td>{{ error.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td>
                                            {% if error.level == 'ERROR' %}
                                                <span class="badge bg-danger">{{ error.level }}</span>
                                            {% elif error.level == 'WARNING' %}
                                                <span class="badge bg-warning text-dark">{{ error.level }}</span>
                                            {% else %}
                                                <span class="badge bg-info">{{ error.level }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ error.source }}</td>
                                        <td>{{ error.message }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-success">
                        <i data-feather="check-circle"></i> No errors reported!
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Statistics Card -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">Usage Statistics (Last 24 Hours)</h5>
            </div>
            <div class="card-body">
                {% if stats %}
                    <div class="row">
                        <div class="col-lg-8">
                            <canvas id="statsChart" height="300"></canvas>
                        </div>
                        <div class="col-lg-4">
                            {% set latest_stats = stats[0] %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">{{ latest_stats.commands_used }}</h3>
                                            <p class="card-text text-muted">Commands Used</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">{{ latest_stats.active_users }}</h3>
                                            <p class="card-text text-muted">Active Users</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">{{ latest_stats.kills_tracked }}</h3>
                                            <p class="card-text text-muted">Kills Tracked</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light mb-3">
                                        <div class="card-body text-center">
                                            <h3 class="card-title">{{ latest_stats.bounties_placed }}</h3>
                                            <p class="card-text text-muted">Bounties Placed</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i data-feather="alert-triangle"></i> No statistics available.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if stats %}
            // Prepare data for chart
            const timestamps = [
                {% for stat in stats|reverse %}
                    '{{ stat.timestamp.strftime("%H:%M") }}',
                {% endfor %}
            ];
            
            const commandData = [
                {% for stat in stats|reverse %}
                    {{ stat.commands_used }},
                {% endfor %}
            ];
            
            const userData = [
                {% for stat in stats|reverse %}
                    {{ stat.active_users }},
                {% endfor %}
            ];
            
            const killsData = [
                {% for stat in stats|reverse %}
                    {{ stat.kills_tracked }},
                {% endfor %}
            ];
            
            // Create chart
            const ctx = document.getElementById('statsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'Commands Used',
                            data: commandData,
                            borderColor: '#7289DA',
                            backgroundColor: 'rgba(114, 137, 218, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Active Users',
                            data: userData,
                            borderColor: '#43B581',
                            backgroundColor: 'rgba(67, 181, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Kills Tracked',
                            data: killsData,
                            borderColor: '#F04747',
                            backgroundColor: 'rgba(240, 71, 71, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        {% endif %}
    });
</script>
{% endblock %}